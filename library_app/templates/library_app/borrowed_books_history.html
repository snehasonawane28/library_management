{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="my-0">My Borrowed Books History</h2>
        {% if total_fine > 0 %}
            <div class="alert alert-warning mb-0 p-2">
                <strong>Total Fine Due:</strong> ₹{{ total_fine }}
            </div>
        {% endif %}
    </div>
    
    <!-- Borrowing History Section -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="h5 mb-0">Borrowing History</h3>
        </div>
    
    {% if borrow_records %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Book Title</th>
                        <th>Borrow Date</th>
                        <th>Due Date</th>
                        <th>Return Date</th>
                        <th>Days Kept</th>
                        <th>Fine</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in borrow_records %}
                    <tr>
                        <td>
                            <a href="{% url 'book_detail' record.book.pk %}" class="text-decoration-none">
                                {{ record.book.title }}
                            </a>
                        </td>
                        <td>{{ record.borrow_date|date:"M d, Y" }}</td>
                        <td>{{ record.due_date|date:"M d, Y" }}</td>
                        <td>
                            {% if record.return_date %}
                                {{ record.return_date|date:"M d, Y" }}
                            {% else %}
                                <span class="text-muted">Not returned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.return_date %}
                                {{ record.days_kept.days }} days
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.fine_amount > 0 %}
                                {% if record.fine_paid %}
                                    <span class="text-success">₹{{ record.fine_amount }} (Paid)</span>
                                {% else %}
                                    <span class="text-danger">₹{{ record.fine_amount }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.return_date %}
                                <span class="badge bg-success">Returned</span>
                            {% else %}
                                {% if timezone.now > record.due_date %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Borrowed</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if not record.return_date %}
                                <form method="post" action="{% url 'return_book' record.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary" 
                                            onclick="return confirm('Are you sure you want to return this book?')">
                                        Return
                                    </button>
                                </form>
                            {% elif record.fine_amount > 0 and not record.fine_paid %}
                                <form method="post" action="{% url 'pay_fine' record.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-success" 
                                            onclick="return confirm('Are you sure you want to pay the fine of ₹{{ record.fine_amount }}?')">
                                        Pay Fine
                                    </button>
                                </form>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div> <!-- Close card-body -->
    </div> <!-- Close card -->
    {% else %}
        <div class="alert alert-info">
            You haven't borrowed any books yet. <a href="{% url 'book_list' %}">Browse our collection</a> to find something interesting!
        </div>
    {% endif %}
</div>

<style>
    .table th {
        font-weight: 600;
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.6em;
    }
    
    a.text-decoration-none {
        color: #0d6efd;
        text-decoration: none;
    }
    
    a.text-decoration-none:hover {
        text-decoration: underline;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}
